#include <tunables/global>

# GameForge Application AppArmor Profile
# Restrictive profile for GameForge containers
profile gameforge-app flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>

  # Capabilities
  capability chown,
  capability setuid,
  capability setgid,
  capability fowner,
  capability dac_override,
  
  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_boot,
  deny capability sys_ptrace,
  deny capability mac_admin,
  deny capability mac_override,

  # Network access
  network tcp,
  network udp,
  network unix,

  # File system access - application directories
  /app/ r,
  /app/** r,
  /app/logs/ rw,
  /app/logs/** rw,
  /app/cache/ rw,
  /app/cache/** rw,
  /app/generated_assets/ rw,
  /app/generated_assets/** rw,
  /app/models_cache/ rw,
  /app/models_cache/** rw,
  /app/tmp/ rw,
  /app/tmp/** rw,

  # Python interpreter and libraries
  /usr/bin/python3* ix,
  /usr/lib/python3*/** r,
  /home/gameforge/.local/** r,
  /home/gameforge/.local/bin/python3* ix,
  /home/gameforge/.local/lib/python3*/** r,

  # System libraries
  /lib/** r,
  /lib64/** r,
  /usr/lib/** r,
  /usr/lib64/** r,
  /usr/share/** r,

  # Device access for GPU
  /dev/nvidia* rw,
  /dev/nvidiactl rw,
  /dev/nvidia-uvm rw,
  /dev/nvidia-modeset rw,

  # Temporary and runtime directories
  /tmp/ rw,
  /tmp/** rw,
  /var/tmp/ rw,
  /var/tmp/** rw,
  /run/ r,
  /run/** rw,

  # Proc and sys (limited)
  @{PROC}/cpuinfo r,
  @{PROC}/meminfo r,
  @{PROC}/stat r,
  @{PROC}/sys/kernel/ostype r,
  @{PROC}/sys/kernel/osrelease r,
  @{PROC}/version r,
  @{PROC}/self/stat r,
  @{PROC}/self/status r,
  @{PROC}/self/cmdline r,
  @{PROC}/self/environ r,
  @{PROC}/self/fd/ r,
  @{PROC}/self/fd/** r,

  # System information
  /sys/devices/system/cpu/ r,
  /sys/devices/system/cpu/** r,
  /sys/devices/pci*/** r,

  # DNS resolution
  /etc/hosts r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/gai.conf r,

  # Time zone
  /etc/timezone r,
  /etc/localtime r,
  /usr/share/zoneinfo/** r,

  # SSL certificates
  /etc/ssl/ r,
  /etc/ssl/** r,
  /usr/local/share/ca-certificates/ r,
  /usr/local/share/ca-certificates/** r,

  # Deny access to sensitive system files
  deny /boot/** rwklx,
  deny /etc/shadow rwklx,
  deny /etc/passwd w,
  deny /etc/group w,
  deny /etc/gshadow rwklx,
  deny /root/** rwklx,
  deny /home/** rwklx,
  deny /var/log/** w,
  deny @{PROC}/sys/kernel/core_pattern w,
  deny @{PROC}/sys/kernel/modprobe w,
  deny @{PROC}/kcore r,
  deny @{PROC}/kallsyms r,
  deny /sys/firmware/** rwklx,
  deny /sys/kernel/debug/** rwklx,

  # Deny mount operations
  deny mount,
  deny umount,
}
