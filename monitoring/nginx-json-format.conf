# ========================================================================
# Nginx JSON Logging Configuration
# Structured access and error logs in JSON format
# ========================================================================

# JSON log format for access logs
log_format json_combined escape=json
'{'
    '"timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request":"$request",'
    '"status":"$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_forwarded_for":"$http_x_forwarded_for",'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time",'
    '"request_id":"$request_id",'
    '"service":"nginx",'
    '"environment":"production",'
    '"log_type":"access"'
'}';

# JSON log format for error logs
log_format json_error escape=json
'{'
    '"timestamp":"$time_iso8601",'
    '"level":"$log_level",'
    '"message":"$log_message",'
    '"service":"nginx",'
    '"environment":"production",'
    '"log_type":"error"'
'}';

# Apply JSON logging
access_log /var/log/nginx/access.log json_combined;
error_log /var/log/nginx/error.log warn;

# Security headers for production
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';" always;

# Rate limiting
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# Request ID for correlation
map $request_id $formatted_request_id {
    "~(?<req_id>.*)" $req_id;
}

# Add request ID to response headers
add_header X-Request-ID $formatted_request_id always;