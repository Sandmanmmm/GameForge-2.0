# SSL/TLS Monitoring Rules for Prometheus
# Add these rules to monitor certificate expiry and SSL health

groups:
  - name: ssl_alerts
    rules:
      # Certificate expiry warnings
      - alert: SSLCertificateExpiringSoon
        expr: (ssl_certificate_expiry_days < 30)
        for: 1h
        labels:
          severity: warning
          service: gameforge
          component: ssl
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days"

      # Certificate expiry critical
      - alert: SSLCertificateExpiringCritical
        expr: (ssl_certificate_expiry_days < 7)
        for: 0m
        labels:
          severity: critical
          service: gameforge
          component: ssl
        annotations:
          summary: "SSL certificate expiring very soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days - IMMEDIATE ACTION REQUIRED"

      # Certificate renewal failed
      - alert: SSLCertificateRenewalFailed
        expr: (ssl_certificate_renewal_status == 0)
        for: 0m
        labels:
          severity: critical
          service: gameforge
          component: ssl
        annotations:
          summary: "SSL certificate renewal failed"
          description: "SSL certificate renewal failed for {{ $labels.domain }}"

      # SSL handshake performance
      - alert: SSLHandshakeSlowdown
        expr: (ssl_handshake_duration_seconds > 1)
        for: 5m
        labels:
          severity: warning
          service: gameforge
          component: ssl
        annotations:
          summary: "SSL handshake taking too long"
          description: "SSL handshake duration is {{ $value }}s, which is above the 1s threshold"

      # SSL connection failures
      - alert: SSLConnectionFailures
        expr: (increase(ssl_connection_errors_total[5m]) > 10)
        for: 2m
        labels:
          severity: warning
          service: gameforge
          component: ssl
        annotations:
          summary: "High SSL connection failure rate"
          description: "{{ $value }} SSL connection failures in the last 5 minutes"

  - name: ssl_certificate_metrics
    rules:
      # Calculate days until certificate expiry
      - record: ssl_certificate_expiry_days
        expr: (ssl_certificate_expiry_timestamp - time()) / 86400

      # SSL certificate health score (0-100)
      - record: ssl_certificate_health_score
        expr: |
          (
            (ssl_certificate_expiry_days > 30) * 40 +
            (ssl_certificate_security_score >= 80) * 30 +
            (ssl_certificate_chain_valid == 1) * 20 +
            (ssl_certificate_ocsp_stapling == 1) * 10
          )

      # SSL performance score (0-100)
      - record: ssl_performance_score
        expr: |
          (
            (ssl_handshake_duration_seconds < 0.5) * 40 +
            (ssl_session_reuse_rate > 0.8) * 30 +
            (ssl_cipher_strength >= 256) * 20 +
            (ssl_protocol_version >= 1.3) * 10
          )
